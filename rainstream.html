<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>RAINSTREAM - Raindrop Detection</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0a1428;color:#00d4ff;font-family:Arial;height:100vh}h1{color:#ffed4e;text-align:center;padding:10px}.container{display:flex;height:100vh}.sidebar{width:200px;background:#000;padding:15px;border-right:2px solid #00d4ff;overflow-y:auto}.stat{margin:15px 0;text-align:center}.label{color:#00d4ff;font-size:0.9em}.value{color:#ffed4e;font-size:2em;font-weight:bold}video{width:100%;height:100%;object-fit:contain}canvas{position:absolute;top:0;left:0}button{background:#00d4ff;color:#000;padding:8px 12px;border:none;border-radius:4px;margin:5px;cursor:pointer;font-weight:bold}button:hover{background:#00ffff}.active{background:#ff8800!important}.main{flex:1;position:relative;overflow:hidden}.controls{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);padding:10px;border-top:2px solid #00d4ff;display:flex;gap:5px;flex-wrap:wrap}select{background:#0a1428;color:#ffed4e;border:1px solid #00d4ff;padding:5px}</style></head><body><h1>‚ö°RAINSTREAM‚ö°</h1><div class="container"><div class="sidebar"><h3 style="color:#ffed4e">üìä STATS</h3><div class="stat"><div class="label">Raindrops</div><div class="value" id="drops">0</div></div><div class="stat"><div class="label">Streams</div><div class="value" style="color:#ff8800" id="streams">0</div></div><div class="stat"><div class="label">Confidence</div><div class="value" id="conf">0%</div></div><div class="stat"><div class="label">Frame</div><div class="value" id="frame">0</div></div></div><div class="main"><video id="v" muted></video><canvas id="c"></canvas><div class="controls"><label style="color:#00d4ff">üìπ<select id="sel" onchange="load()"><option value="20251224_221145.mp4">V1</option><option value="20251224_221256.mp4">V2</option></select></label><button onclick="play()">‚ñ∂ PLAY</button><button onclick="stop()">‚èπ STOP</button><button id="det" onclick="detect()" class="active">üîç DETECT</button><button id="drw" onclick="draw()">üñä DRAW</button><button onclick="clr()">üóë CLEAR</button></div></div></div><script>const s={mode:'detect',play:0,frame:0,det:1,drops:[],streams:[],current:null,maxdrops:0};const v=document.getElementById('v');const c=document.getElementById('c');const x=c.getContext('2d');function init(){const r=c.parentElement.getBoundingClientRect();c.width=r.width;c.height=r.height}window.addEventListener('load',init);window.addEventListener('resize',init);function load(){v.src=document.getElementById('sel').value;reset()}function play(){if(s.play){v.pause();s.play=0}else{v.play();s.play=1;loop()}}function stop(){v.pause();s.play=0}function reset(){v.currentTime=0;s.frame=0;s.drops=[];s.streams=[];s.maxdrops=0;s.play=0;x.clearRect(0,0,c.width,c.height);ui()}function detect(){s.mode='detect';s.det=1;document.getElementById('det').classList.add('active');document.getElementById('drw').classList.remove('active')}function draw(){if(s.maxdrops===0){alert('Detect first!');return}s.mode='draw';s.det=0;document.getElementById('det').classList.remove('active');document.getElementById('drw').classList.add('active')}function clr(){s.streams=[];s.current=null;ui()}function find(img){const d=img.data;const p=[];const w=img.width;const t=120;for(let i=0;i<d.length;i+=4){const b=(d[i]+d[i+1]+d[i+2])/3;if(b>t){const idx=i/4;const x=idx%w;const y=Math.floor(idx/w);p.push({x,y,b})}}return cluster(p)}function cluster(p){if(p.length<3)return[];const c=[];const u=new Set();for(let i=0;i<p.length;i++){if(u.has(i))continue;const cl=[p[i]];u.add(i);for(let j=i+1;j<p.length;j++){if(u.has(j))continue;const dx=p[i].x-p[j].x;const dy=p[i].y-p[j].y;const d=Math.sqrt(dx*dx+dy*dy);if(d<25){cl.push(p[j]);u.add(j)}}if(cl.length>=2){const cx=cl.reduce((a,pt)=>a+pt.x,0)/cl.length;const cy=cl.reduce((a,pt)=>a+pt.y,0)/cl.length;const cb=cl.reduce((a,pt)=>a+pt.b,0)/cl.length;const r=Math.sqrt(cl.length/Math.PI)+2;const con=Math.min(1,(cb-120)/135);c.push({x:cx,y:cy,r:r,con:con})}}return c}function drawFrame(){x.clearRect(0,0,c.width,c.height);if(s.det){s.drops.forEach(d=>{x.strokeStyle=`rgba(255,237,74,${d.con})`;x.lineWidth=2;x.beginPath();x.arc(d.x,d.y,d.r,0,Math.PI*2);x.stroke()})}s.streams.forEach(st=>{x.strokeStyle='#ff8800';x.lineWidth=3;x.lineCap='round';x.beginPath();x.moveTo(st.start.x,st.start.y);x.lineTo(st.end.x,st.end.y);x.stroke()});if(s.current){x.strokeStyle='rgba(255,136,0,0.7)';x.lineWidth=3;x.beginPath();x.moveTo(s.current.start.x,s.current.start.y);x.lineTo(s.current.end.x,s.current.end.y);x.stroke()}}c.addEventListener('mousedown',(e)=>{if(!s.play||s.mode!=='draw')return;const r=c.getBoundingClientRect();s.current={start:{x:e.clientX-r.left,y:e.clientY-r.top},end:{x:e.clientX-r.left,y:e.clientY-r.top}}});c.addEventListener('mousemove',(e)=>{if(!s.current)return;const r=c.getBoundingClientRect();s.current.end={x:e.clientX-r.left,y:e.clientY-r.top}});c.addEventListener('mouseup',(e)=>{if(!s.current)return;const dx=s.current.end.x-s.current.start.x;const dy=s.current.end.y-s.current.start.y;if(Math.sqrt(dx*dx+dy*dy)>20){s.streams.push(s.current)}s.current=null;ui()});function loop(){if(s.play&&!v.paused&&v.readyState===v.HAVE_ENOUGH_DATA){x.drawImage(v,0,0,c.width,c.height);const img=x.getImageData(0,0,c.width,c.height);s.drops=find(img);s.maxdrops=Math.max(s.maxdrops,s.drops.length);s.frame++;ui()}drawFrame();requestAnimationFrame(loop)}function ui(){document.getElementById('drops').textContent=s.maxdrops;document.getElementById('streams').textContent=s.streams.length;document.getElementById('frame').textContent=s.frame;const conf=s.drops.length>0?Math.round((s.drops.reduce((a,d)=>a+d.con,0)/s.drops.length)*100):0;document.getElementById('conf').textContent=conf+'%'}load()</script></body></html>
